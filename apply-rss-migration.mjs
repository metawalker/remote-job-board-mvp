// Generated by Copilot
import { createClient } from '@supabase/supabase-js'
import fs from 'fs'

const supabaseUrl = 'https://czvkltyhkzbuvsvqdlun.supabase.co'
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dmtsdHloa3pidXZzdnFkbHVuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDUxMTgxMSwiZXhwIjoyMDY2MDg3ODExfQ.g-EmjKB06zXK46-2AdupzKXhTsEePklWuBgqBqNCbTI'

async function runMigration() {
  try {
    console.log('Running RSS scraper migration manually...')
    
    const supabase = createClient(supabaseUrl, supabaseServiceKey)
    
    // Add source column
    console.log('Adding source column...')
    const { error: sourceError } = await supabase
      .rpc('exec_raw_sql', {
        sql: 'ALTER TABLE jobs ADD COLUMN IF NOT EXISTS source TEXT;'
      })
    
    if (sourceError && !sourceError.message.includes('already exists')) {
      console.error('Error adding source column:', sourceError)
    } else {
      console.log('✅ Source column added successfully')
    }
    
    // Add salary_text column
    console.log('Adding salary_text column...')
    const { error: salaryError } = await supabase
      .rpc('exec_raw_sql', {
        sql: 'ALTER TABLE jobs ADD COLUMN IF NOT EXISTS salary_text TEXT;'
      })
    
    if (salaryError && !salaryError.message.includes('already exists')) {
      console.error('Error adding salary_text column:', salaryError)
    } else {
      console.log('✅ Salary_text column added successfully')
    }
    
    // Add index
    console.log('Adding index...')
    const { error: indexError } = await supabase
      .rpc('exec_raw_sql', {
        sql: 'CREATE INDEX IF NOT EXISTS idx_jobs_source ON jobs(source);'
      })
    
    if (indexError) {
      console.error('Error adding index:', indexError)
    } else {
      console.log('✅ Index added successfully')
    }
    
    // Add fully_remote enum value
    console.log('Adding fully_remote enum value...')
    const { error: enumError } = await supabase
      .rpc('exec_raw_sql', {
        sql: "ALTER TYPE remote_type ADD VALUE IF NOT EXISTS 'fully_remote';"
      })
    
    if (enumError) {
      console.error('Error adding enum value:', enumError)
    } else {
      console.log('✅ Enum value added successfully')
    }
    
    console.log('Migration completed successfully!')
    
  } catch (error) {
    console.error('Migration failed:', error)
    // Try alternative direct approach
    console.log('Trying direct table modification...')
      // Test with a simple select to see current structure
    const supabase = createClient(supabaseUrl, supabaseServiceKey)
    const { data, error: selectError } = await supabase
      .from('jobs')
      .select('*')
      .limit(1)
    
    if (data && data.length > 0) {
      console.log('Current job table columns:', Object.keys(data[0]))
      
      if (!Object.keys(data[0]).includes('source')) {
        console.log('Source column missing - migration needed')
      }
      if (!Object.keys(data[0]).includes('salary_text')) {
        console.log('Salary_text column missing - migration needed')
      }
    }
  }
}

runMigration()
